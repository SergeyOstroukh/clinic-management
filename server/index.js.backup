require('dotenv').config();
const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');
const sqlite3 = require('sqlite3').verbose();
const path = require('path');
const fs = require('fs');

const app = express();
const PORT = process.env.PORT || 3001;
const NODE_ENV = process.env.NODE_ENV || 'development';

// Middleware
const corsOptions = {
  origin: process.env.CORS_ORIGIN || '*',
  credentials: true
};
app.use(cors(corsOptions));
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

// ะะฝะธัะธะฐะปะธะทะฐัะธั ะฑะฐะทั ะดะฐะฝะฝัั
// ะัะฟะพะปัะทัะตะผ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั ะดะปั ะฟััะธ ะบ ะะ (ะดะปั Railway Volume)
const dbPath = process.env.DATABASE_PATH || path.join(__dirname, 'clinic.db');
console.log('๐ ะััั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั:', dbPath);
const db = new sqlite3.Database(dbPath);

// ะกะพะทะดะฐะฝะธะต ัะฐะฑะปะธั
db.serialize(() => {
  // ะขะฐะฑะปะธัะฐ ะบะปะธะตะฝัะพะฒ
  db.run(`CREATE TABLE IF NOT EXISTS clients (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    lastName TEXT,
    firstName TEXT,
    middleName TEXT,
    phone TEXT,
    address TEXT,
    email TEXT,
    notes TEXT,
    name TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )`);

  // ะะธะณัะฐัะธั: ะดะพะฑะฐะฒะปัะตะผ ะฝะพะฒัะต ะฟะพะปั ะตัะปะธ ะธั ะฝะตั
  db.run(`ALTER TABLE clients ADD COLUMN lastName TEXT`, (err) => {
    if (err && !err.message.includes('duplicate column')) {
      console.error('ะัะธะฑะบะฐ ะดะพะฑะฐะฒะปะตะฝะธั lastName:', err.message);
    }
  });
  db.run(`ALTER TABLE clients ADD COLUMN firstName TEXT`, (err) => {
    if (err && !err.message.includes('duplicate column')) {
      console.error('ะัะธะฑะบะฐ ะดะพะฑะฐะฒะปะตะฝะธั firstName:', err.message);
    }
  });
  db.run(`ALTER TABLE clients ADD COLUMN middleName TEXT`, (err) => {
    if (err && !err.message.includes('duplicate column')) {
      console.error('ะัะธะฑะบะฐ ะดะพะฑะฐะฒะปะตะฝะธั middleName:', err.message);
    }
  });
  db.run(`ALTER TABLE clients ADD COLUMN address TEXT`, (err) => {
    if (err && !err.message.includes('duplicate column')) {
      console.error('ะัะธะฑะบะฐ ะดะพะฑะฐะฒะปะตะฝะธั address:', err.message);
    }
  });

  // ะขะฐะฑะปะธัะฐ ััะปัะณ
  db.run(`CREATE TABLE IF NOT EXISTS services (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    price REAL NOT NULL,
    description TEXT,
    category TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )`);

  // ะะธะณัะฐัะธั: ะดะพะฑะฐะฒะปัะตะผ ะฟะพะปะต category (ัะฐะทะดะตะป/ะบะฐัะตะณะพัะธั ััะปัะณะธ)
  db.run(`ALTER TABLE services ADD COLUMN category TEXT`, (err) => {
    if (err && !err.message.includes('duplicate column')) {
      console.error('ะัะธะฑะบะฐ ะดะพะฑะฐะฒะปะตะฝะธั category:', err.message);
    }
  });

  // ะขะฐะฑะปะธัะฐ ะฒัะฐัะตะน
  db.run(`CREATE TABLE IF NOT EXISTS doctors (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    lastName TEXT NOT NULL,
    firstName TEXT NOT NULL,
    middleName TEXT,
    specialization TEXT,
    phone TEXT,
    email TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )`);

  // ะขะฐะฑะปะธัะฐ ะทะฐะฟะธัะตะน
  db.run(`CREATE TABLE IF NOT EXISTS appointments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    client_id INTEGER NOT NULL,
    appointment_date DATETIME NOT NULL,
    doctor TEXT,
    status TEXT DEFAULT 'scheduled',
    called_today INTEGER DEFAULT 0,
    notes TEXT,
    total_price REAL DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (client_id) REFERENCES clients(id)
  )`);

  // ะะธะณัะฐัะธั: ะดะพะฑะฐะฒะปัะตะผ ะฟะพะปะต doctor ะตัะปะธ ะตะณะพ ะฝะตั (ััะฐัะพะต ัะตะบััะพะฒะพะต ะฟะพะปะต, ะพััะฐะฒะธะผ ะดะปั ะพะฑัะฐัะฝะพะน ัะพะฒะผะตััะธะผะพััะธ)
  db.run(`ALTER TABLE appointments ADD COLUMN doctor TEXT`, (err) => {
    if (err && !err.message.includes('duplicate column')) {
      console.error('ะัะธะฑะบะฐ ะดะพะฑะฐะฒะปะตะฝะธั doctor:', err.message);
    }
  });

  // ะะธะณัะฐัะธั: ะดะพะฑะฐะฒะปัะตะผ ะฟะพะปะต doctor_id ะดะปั ัะฒัะทะธ ั ัะฐะฑะปะธัะตะน doctors
  db.run(`ALTER TABLE appointments ADD COLUMN doctor_id INTEGER`, (err) => {
    if (err && !err.message.includes('duplicate column')) {
      console.error('ะัะธะฑะบะฐ ะดะพะฑะฐะฒะปะตะฝะธั doctor_id:', err.message);
    }
  });
  
  // ะะธะณัะฐัะธั: ะดะพะฑะฐะฒะปัะตะผ ะฟะพะปะต called_today ะตัะปะธ ะตะณะพ ะฝะตั
  db.run(`ALTER TABLE appointments ADD COLUMN called_today INTEGER DEFAULT 0`, (err) => {
    if (err && !err.message.includes('duplicate column')) {
      console.error('ะัะธะฑะบะฐ ะดะพะฑะฐะฒะปะตะฝะธั called_today:', err.message);
    }
  });

  // ะะธะณัะฐัะธั: ะดะพะฑะฐะฒะปัะตะผ ะฟะพะปะต diagnosis (ะดะธะฐะณะฝะพะท)
  db.run(`ALTER TABLE appointments ADD COLUMN diagnosis TEXT`, (err) => {
    if (err && !err.message.includes('duplicate column')) {
      console.error('ะัะธะฑะบะฐ ะดะพะฑะฐะฒะปะตะฝะธั diagnosis:', err.message);
    }
  });

  // ะะธะณัะฐัะธั: ะดะพะฑะฐะฒะปัะตะผ ะฟะพะปะต discount_amount (ััะผะผะฐ ัะบะธะดะบะธ)
  db.run(`ALTER TABLE appointments ADD COLUMN discount_amount REAL DEFAULT 0`, (err) => {
    if (err && !err.message.includes('duplicate column')) {
      console.error('ะัะธะฑะบะฐ ะดะพะฑะฐะฒะปะตะฝะธั discount_amount:', err.message);
    }
  });

  // ะะธะณัะฐัะธั: ะดะพะฑะฐะฒะปัะตะผ ะฟะพะปะต paid (ะพะฟะปะฐัะตะฝะพ/ะฝะต ะพะฟะปะฐัะตะฝะพ)
  db.run(`ALTER TABLE appointments ADD COLUMN paid INTEGER DEFAULT 0`, (err) => {
    if (err && !err.message.includes('duplicate column')) {
      console.error('ะัะธะฑะบะฐ ะดะพะฑะฐะฒะปะตะฝะธั paid:', err.message);
    }
  });

  // ะขะฐะฑะปะธัะฐ ะผะฐัะตัะธะฐะปะพะฒ
  db.run(`CREATE TABLE IF NOT EXISTS materials (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    unit TEXT,
    price REAL NOT NULL,
    stock REAL DEFAULT 0,
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )`);

  // ะขะฐะฑะปะธัะฐ ัะฒัะทะธ ะทะฐะฟะธัะตะน ะธ ััะปัะณ (ะผะฝะพะณะธะต ะบะพ ะผะฝะพะณะธะผ)
  db.run(`CREATE TABLE IF NOT EXISTS appointment_services (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    appointment_id INTEGER NOT NULL,
    service_id INTEGER NOT NULL,
    quantity INTEGER DEFAULT 1,
    FOREIGN KEY (appointment_id) REFERENCES appointments(id),
    FOREIGN KEY (service_id) REFERENCES services(id)
  )`);

  // ะขะฐะฑะปะธัะฐ ัะฒัะทะธ ะทะฐะฟะธัะตะน ะธ ะผะฐัะตัะธะฐะปะพะฒ
  db.run(`CREATE TABLE IF NOT EXISTS appointment_materials (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    appointment_id INTEGER NOT NULL,
    material_id INTEGER NOT NULL,
    quantity REAL DEFAULT 1,
    FOREIGN KEY (appointment_id) REFERENCES appointments(id),
    FOREIGN KEY (material_id) REFERENCES materials(id)
  )`);

  // ะขะฐะฑะปะธัะฐ ะฟะพะปัะทะพะฒะฐัะตะปะตะน (ะดะปั ะฐะฒัะพัะธะทะฐัะธะธ)
  db.run(`CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password TEXT NOT NULL,
    role TEXT NOT NULL,
    doctor_id INTEGER,
    full_name TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (doctor_id) REFERENCES doctors(id)
  )`, (err) => {
    if (err) {
      console.error('ะัะธะฑะบะฐ ัะพะทะดะฐะฝะธั ัะฐะฑะปะธัั users:', err.message);
    } else {
      // ะัะพะฒะตััะตะผ, ะตััั ะปะธ ะฟะพะปัะทะพะฒะฐัะตะปะธ, ะตัะปะธ ะฝะตั - ัะพะทะดะฐะตะผ ะฝะฐัะฐะปัะฝัั
      db.get("SELECT COUNT(*) as count FROM users", (err, row) => {
        if (!err && row.count === 0) {
          console.log('ะกะพะทะดะฐะตะผ ะฝะฐัะฐะปัะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน...');
          
          // ะะปะฐะฒะฝัะน ะฐะดะผะธะฝ
          db.run("INSERT INTO users (username, password, role, full_name) VALUES (?, ?, ?, ?)",
            ['Admin', 'admin', 'superadmin', 'ะะปะฐะฒะฝัะน ะฐะดะผะธะฝะธัััะฐัะพั']);
          
          // ะะดะผะธะฝะธัััะฐัะพั
          db.run("INSERT INTO users (username, password, role, full_name) VALUES (?, ?, ?, ?)",
            ['Administrator', 'administrator', 'administrator', 'ะะดะผะธะฝะธัััะฐัะพั']);
          
          // ะัะฐั (ัะพะทะดะฐะดะธะผ ะฒัะฐัะฐ, ะตัะปะธ ะตะณะพ ะฝะตั)
          db.get("SELECT id FROM doctors WHERE lastName = 'Doctor' AND firstName = 'Test'", (err, doctor) => {
            if (!doctor) {
              // ะกะพะทะดะฐะตะผ ัะตััะพะฒะพะณะพ ะฒัะฐัะฐ
              db.run("INSERT INTO doctors (lastName, firstName, specialization) VALUES (?, ?, ?)",
                ['Doctor', 'Test', 'ะขะตัะฐะฟะตะฒั'], function(err) {
                  if (!err) {
                    // ะัะธะฒัะทัะฒะฐะตะผ ะฟะพะปัะทะพะฒะฐัะตะปั ะบ ะฒัะฐัั
                    db.run("INSERT INTO users (username, password, role, doctor_id, full_name) VALUES (?, ?, ?, ?, ?)",
                      ['Doctor1', 'doctor', 'doctor', this.lastID, 'ะัะฐั ะขะตััะพะฒัะน']);
                  }
                });
            } else {
              // ะัะปะธ ะฒัะฐั ัะถะต ะตััั, ะฟัะธะฒัะทัะฒะฐะตะผ ะบ ะฝะตะผั
              db.run("INSERT INTO users (username, password, role, doctor_id, full_name) VALUES (?, ?, ?, ?, ?)",
                ['Doctor1', 'doctor', 'doctor', doctor.id, 'ะัะฐั ะขะตััะพะฒัะน']);
            }
          });
          
          console.log('ะะฐัะฐะปัะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ ัะพะทะดะฐะฝั');
        }
      });
    }
  });

  // ะะพะฑะฐะฒะปัะตะผ ัะตััะพะฒัะต ะดะฐะฝะฝัะต, ะตัะปะธ ะฑะฐะทะฐ ะฟัััะฐั
  db.get("SELECT COUNT(*) as count FROM services", (err, row) => {
    if (row.count === 0) {
      const defaultServices = [
        ['ะะพะฝััะปััะฐัะธั', 1500, 'ะะตัะฒะธัะฝะฐั ะบะพะฝััะปััะฐัะธั ะฒัะฐัะฐ'],
        ['ะัะผะพัั', 2000, 'ะะพะปะฝัะน ะพัะผะพัั ะฟะฐัะธะตะฝัะฐ'],
        ['ะะฝะฐะปะธะทั', 3000, 'ะะฐะฑะพัะฐัะพัะฝัะต ะฐะฝะฐะปะธะทั'],
        ['ะัะพัะตะดััะฐ', 2500, 'ะะตัะตะฑะฝะฐั ะฟัะพัะตะดััะฐ']
      ];
      const stmt = db.prepare("INSERT INTO services (name, price, description) VALUES (?, ?, ?)");
      defaultServices.forEach(service => {
        stmt.run(service);
      });
      stmt.finalize();
    }
  });

  // ะะพะฑะฐะฒะปัะตะผ ัะตััะพะฒัะต ะผะฐัะตัะธะฐะปั, ะตัะปะธ ะฑะฐะทะฐ ะฟัััะฐั
  db.get("SELECT COUNT(*) as count FROM materials", (err, row) => {
    if (!err && row.count === 0) {
      const defaultMaterials = [
        ['ะะธะฝั ััะตัะธะปัะฝัะน', 'ัั', 50, 100, 'ะกัะตัะธะปัะฝัะน ะผะตะดะธัะธะฝัะบะธะน ะฑะธะฝั'],
        ['ะะฐัะฐ ะผะตะดะธัะธะฝัะบะฐั', 'ัะฟะฐะบ', 30, 50, 'ะะตะดะธัะธะฝัะบะฐั ะฒะฐัะฐ 100ะณ'],
        ['ะจะฟัะธั ะพะดะฝะพัะฐะทะพะฒัะน 5ะผะป', 'ัั', 20, 200, 'ะะดะฝะพัะฐะทะพะฒัะน ัะฟัะธั'],
        ['ะะตััะฐัะบะธ ะปะฐัะตะบัะฝัะต', 'ะฟะฐัะฐ', 15, 500, 'ะะตะดะธัะธะฝัะบะธะต ะฟะตััะฐัะบะธ'],
        ['ะะฐัะบะฐ ะผะตะดะธัะธะฝัะบะฐั', 'ัั', 10, 300, 'ะะดะฝะพัะฐะทะพะฒะฐั ะผะฐัะบะฐ'],
        ['ะกะฟะธัั ะผะตะดะธัะธะฝัะบะธะน', 'ะผะป', 5, 1000, 'ะญัะธะปะพะฒัะน ัะฟะธัั 96%'],
        ['ะะพะด', 'ัะปะฐะบะพะฝ', 80, 20, 'ะะฐััะฒะพั ะนะพะดะฐ 5%'],
        ['ะะตัะตะบะธัั ะฒะพะดะพัะพะดะฐ', 'ัะปะฐะบะพะฝ', 60, 30, 'ะะฐััะฒะพั ะฟะตัะตะบะธัะธ 3%']
      ];
      const stmt = db.prepare("INSERT INTO materials (name, unit, price, stock, description) VALUES (?, ?, ?, ?, ?)");
      defaultMaterials.forEach(material => {
        stmt.run(material);
      });
      stmt.finalize();
      console.log('ะขะตััะพะฒัะต ะผะฐัะตัะธะฐะปั ะดะพะฑะฐะฒะปะตะฝั');
    }
  });
});

// ========== API ROUTES ==========

// ===== ะะะขะะะะะะฆะะฏ =====
// ะัะพะด ะฒ ัะธััะตะผั
app.post('/api/auth/login', (req, res) => {
  const { username, password } = req.body;
  
  db.get(
    "SELECT u.*, d.lastName as doctor_lastName, d.firstName as doctor_firstName, d.middleName as doctor_middleName FROM users u LEFT JOIN doctors d ON u.doctor_id = d.id WHERE u.username = ? AND u.password = ?",
    [username, password],
    (err, user) => {
      if (err) {
        res.status(500).json({ error: err.message });
        return;
      }
      
      if (!user) {
        res.status(401).json({ error: 'ะะตะฒะตัะฝัะน ะปะพะณะธะฝ ะธะปะธ ะฟะฐัะพะปั' });
        return;
      }
      
      // ะคะพัะผะธััะตะผ ะดะฐะฝะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปั
      const userData = {
        id: user.id,
        username: user.username,
        role: user.role,
        full_name: user.full_name,
        doctor_id: user.doctor_id,
        doctor_name: user.doctor_lastName ? 
          `${user.doctor_lastName} ${user.doctor_firstName} ${user.doctor_middleName || ''}`.trim() : null
      };
      
      res.json({ 
        message: 'ะะฒัะพัะธะทะฐัะธั ััะฟะตัะฝะฐ',
        user: userData
      });
    }
  );
});

// ะะพะปััะธัั ัะตะบััะตะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั (ะฟัะพะฒะตัะบะฐ ัะตััะธะธ)
app.get('/api/auth/me', (req, res) => {
  // ะ ัะตะฐะปัะฝะพะผ ะฟัะพะตะบัะต ะทะดะตัั ะฟัะพะฒะตััะปัั ะฑั ัะพะบะตะฝ ะธะท ะทะฐะณะพะปะพะฒะบะฐ
  // ะะปั ะฟัะพััะพัั ะฟะพะบะฐ ะฒะพะทะฒัะฐัะฐะตะผ ะฟัะพััะพ ััะฐััั
  res.json({ message: 'ะัะฟะพะปัะทัะนัะต localStorage ะฝะฐ ะบะปะธะตะฝัะต' });
});

// ะััะพะด ะธะท ัะธััะตะผั
app.post('/api/auth/logout', (req, res) => {
  res.json({ message: 'ะััะพะด ะฒัะฟะพะปะฝะตะฝ' });
});

// ===== ะะะะะะขะซ =====
// ะะพะปััะธัั ะฒัะตั ะบะปะธะตะฝัะพะฒ
app.get('/api/clients', (req, res) => {
  db.all("SELECT * FROM clients ORDER BY created_at DESC", (err, rows) => {
    if (err) {
      res.status(500).json({ error: err.message });
      return;
    }
    res.json(rows);
  });
});

// ะกะพะทะดะฐัั ะบะปะธะตะฝัะฐ
app.post('/api/clients', (req, res) => {
  const { lastName, firstName, middleName, phone, address, email, notes, name } = req.body;
  
  // ะะพะดะดะตัะถะบะฐ ััะฐัะพะณะพ ัะพัะผะฐัะฐ (ะตัะปะธ ะฟะตัะตะดะฐะฝะพ ัะพะปัะบะพ name)
  const finalLastName = lastName || '';
  const finalFirstName = firstName || '';
  const finalMiddleName = middleName || '';
  const legacyName = name || `${lastName} ${firstName} ${middleName}`.trim();
  
  db.run(
    `INSERT INTO clients (lastName, firstName, middleName, phone, address, email, notes, name) 
     VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
    [
      finalLastName,
      finalFirstName, 
      finalMiddleName,
      phone || null,
      address || null,
      email || null,
      notes || null,
      legacyName
    ],
    function(err) {
      if (err) {
        res.status(500).json({ error: err.message });
        return;
      }
      res.json({ 
        id: this.lastID, 
        lastName: finalLastName,
        firstName: finalFirstName,
        middleName: finalMiddleName,
        phone, 
        address,
        email, 
        notes,
        name: legacyName
      });
    }
  );
});

// ะะพะปััะธัั ะฒัะต ััะปัะณะธ
app.get('/api/services', (req, res) => {
  db.all("SELECT * FROM services ORDER BY name", (err, rows) => {
    if (err) {
      res.status(500).json({ error: err.message });
      return;
    }
    res.json(rows);
  });
});

// ะกะพะทะดะฐัั ััะปัะณั
app.post('/api/services', (req, res) => {
  const { name, price, description, category } = req.body;
  db.run(
    "INSERT INTO services (name, price, description, category) VALUES (?, ?, ?, ?)",
    [name, price, description || null, category || null],
    function(err) {
      if (err) {
        res.status(500).json({ error: err.message });
        return;
      }
      res.json({ id: this.lastID, name, price, description, category });
    }
  );
});

// ะะฑะฝะพะฒะธัั ััะปัะณั
app.put('/api/services/:id', (req, res) => {
  const { name, price, description, category } = req.body;
  db.run(
    "UPDATE services SET name = ?, price = ?, description = ?, category = ? WHERE id = ?",
    [name, price, description || null, category || null, req.params.id],
    function(err) {
      if (err) {
        res.status(500).json({ error: err.message });
        return;
      }
      res.json({ message: 'ะฃัะปัะณะฐ ะพะฑะฝะพะฒะปะตะฝะฐ', changes: this.changes });
    }
  );
});

// ะฃะดะฐะปะธัั ััะปัะณั
app.delete('/api/services/:id', (req, res) => {
  db.run("DELETE FROM services WHERE id = ?", [req.params.id], function(err) {
    if (err) {
      res.status(500).json({ error: err.message });
      return;
    }
    res.json({ message: 'ะฃัะปัะณะฐ ัะดะฐะปะตะฝะฐ', changes: this.changes });
  });
});

// ===== ะะะขะะะะะะซ (MATERIALS) =====

// ะะพะปััะธัั ะฒัะต ะผะฐัะตัะธะฐะปั
app.get('/api/materials', (req, res) => {
  db.all("SELECT * FROM materials ORDER BY name", (err, rows) => {
    if (err) {
      res.status(500).json({ error: err.message });
      return;
    }
    res.json(rows);
  });
});

// ะกะพะทะดะฐัั ะผะฐัะตัะธะฐะป
app.post('/api/materials', (req, res) => {
  const { name, unit, price, stock, description } = req.body;
  db.run(
    "INSERT INTO materials (name, unit, price, stock, description) VALUES (?, ?, ?, ?, ?)",
    [name, unit || '', price, stock || 0, description || ''],
    function(err) {
      if (err) {
        res.status(500).json({ error: err.message });
        return;
      }
      res.json({ id: this.lastID, message: 'ะะฐัะตัะธะฐะป ัะพะทะดะฐะฝ' });
    }
  );
});

// ะะฑะฝะพะฒะธัั ะผะฐัะตัะธะฐะป
app.put('/api/materials/:id', (req, res) => {
  const { name, unit, price, stock, description } = req.body;
  db.run(
    "UPDATE materials SET name = ?, unit = ?, price = ?, stock = ?, description = ? WHERE id = ?",
    [name, unit, price, stock, description, req.params.id],
    function(err) {
      if (err) {
        res.status(500).json({ error: err.message });
        return;
      }
      res.json({ message: 'ะะฐัะตัะธะฐะป ะพะฑะฝะพะฒะปะตะฝ', changes: this.changes });
    }
  );
});

// ะฃะดะฐะปะธัั ะผะฐัะตัะธะฐะป
app.delete('/api/materials/:id', (req, res) => {
  db.run("DELETE FROM materials WHERE id = ?", [req.params.id], function(err) {
    if (err) {
      res.status(500).json({ error: err.message });
      return;
    }
    res.json({ message: 'ะะฐัะตัะธะฐะป ัะดะฐะปะตะฝ', changes: this.changes });
  });
});

// ===== ะะะะงะ (DOCTORS) =====

// ะะพะปััะธัั ะฒัะตั ะฒัะฐัะตะน
app.get('/api/doctors', (req, res) => {
  db.all("SELECT * FROM doctors ORDER BY lastName, firstName", (err, rows) => {
    if (err) {
      res.status(500).json({ error: err.message });
      return;
    }
    res.json(rows);
  });
});

// ะกะพะทะดะฐัั ะฒัะฐัะฐ
app.post('/api/doctors', (req, res) => {
  const { lastName, firstName, middleName, specialization, phone, email } = req.body;
  db.run(
    "INSERT INTO doctors (lastName, firstName, middleName, specialization, phone, email) VALUES (?, ?, ?, ?, ?, ?)",
    [lastName, firstName, middleName || null, specialization || null, phone || null, email || null],
    function(err) {
      if (err) {
        res.status(500).json({ error: err.message });
        return;
      }
      res.json({ id: this.lastID, lastName, firstName, middleName, specialization, phone, email });
    }
  );
});

// ะะฑะฝะพะฒะธัั ะฒัะฐัะฐ
app.put('/api/doctors/:id', (req, res) => {
  const { lastName, firstName, middleName, specialization, phone, email } = req.body;
  db.run(
    "UPDATE doctors SET lastName = ?, firstName = ?, middleName = ?, specialization = ?, phone = ?, email = ? WHERE id = ?",
    [lastName, firstName, middleName || null, specialization || null, phone || null, email || null, req.params.id],
    function(err) {
      if (err) {
        res.status(500).json({ error: err.message });
        return;
      }
      res.json({ message: 'ะัะฐั ะพะฑะฝะพะฒะปะตะฝ', changes: this.changes });
    }
  );
});

// ะฃะดะฐะปะธัั ะฒัะฐัะฐ
app.delete('/api/doctors/:id', (req, res) => {
  db.run("DELETE FROM doctors WHERE id = ?", [req.params.id], function(err) {
    if (err) {
      res.status(500).json({ error: err.message });
      return;
    }
    res.json({ message: 'ะัะฐั ัะดะฐะปะตะฝ', changes: this.changes });
  });
});

// ===== ะะะะะกะ (APPOINTMENTS) =====

// ะะพะปััะธัั ะฒัะต ะทะฐะฟะธัะธ ั ะธะฝัะพัะผะฐัะธะตะน ะพ ะบะปะธะตะฝัะฐั ะธ ััะปัะณะฐั
app.get('/api/appointments', (req, res) => {
  // ะะพะปััะฐะตะผ ะฒัะต ะทะฐะฟะธัะธ ั ะธะฝัะพัะผะฐัะธะตะน ะพ ะฒัะฐัะต
  db.all(
    `SELECT 
      a.*,
      d.lastName as doctor_lastName,
      d.firstName as doctor_firstName,
      d.middleName as doctor_middleName,
      d.specialization as doctor_specialization
    FROM appointments a
    LEFT JOIN doctors d ON a.doctor_id = d.id
    ORDER BY a.id ASC`,
    (err, appointments) => {
      if (err) {
        res.status(500).json({ error: err.message });
        return;
      }
      
      // ะะปั ะบะฐะถะดะพะน ะทะฐะฟะธัะธ ะฟะพะปััะฐะตะผ ะตั ััะปัะณะธ
      const appointmentsWithServices = [];
      let processed = 0;
      
      if (appointments.length === 0) {
        return res.json([]);
      }
      
      appointments.forEach(appointment => {
        db.all(
          `SELECT aps.service_id, aps.quantity, s.name, s.price 
           FROM appointment_services aps
           JOIN services s ON aps.service_id = s.id
           WHERE aps.appointment_id = ?`,
          [appointment.id],
          (err, services) => {
            if (err) {
              console.error('ะัะธะฑะบะฐ ะฟะพะปััะตะฝะธั ััะปัะณ:', err);
              services = [];
            }
            
            // ะคะพัะผะธััะตะผ ะผะฐััะธะฒ ััะปัะณ ะฒ ะฝัะถะฝะพะผ ัะพัะผะฐัะต
            const servicesArray = services.map(s => ({
              service_id: s.service_id,
              quantity: s.quantity
            }));
            
            // ะคะพัะผะธััะตะผ ะพะฑัะตะบั ะฒัะฐัะฐ
            const doctorInfo = appointment.doctor_lastName ? {
              lastName: appointment.doctor_lastName,
              firstName: appointment.doctor_firstName,
              middleName: appointment.doctor_middleName,
              specialization: appointment.doctor_specialization
            } : null;
            
            appointmentsWithServices.push({
              ...appointment,
              doctor: doctorInfo,
              services: servicesArray
            });
            
            processed++;
            if (processed === appointments.length) {
              res.json(appointmentsWithServices);
            }
          }
        );
      });
    }
  );
});

// ะกะพะทะดะฐัั ะทะฐะฟะธัั
app.post('/api/appointments', (req, res) => {
  const { client_id, appointment_date, doctor_id, services, notes } = req.body;
  
  // ะกะฝะฐัะฐะปะฐ ัะพะทะดะฐะตะผ ะทะฐะฟะธัั
  db.run(
    "INSERT INTO appointments (client_id, appointment_date, doctor_id, notes) VALUES (?, ?, ?, ?)",
    [client_id, appointment_date, doctor_id || null, notes || null],
    function(err) {
      if (err) {
        res.status(500).json({ error: err.message });
        return;
      }
      
      const appointmentId = this.lastID;
      let totalPrice = 0;
      
      // ะะพะฑะฐะฒะปัะตะผ ััะปัะณะธ ะธ ััะธัะฐะตะผ ะพะฑััั ััะพะธะผะพััั
      if (services && services.length > 0) {
        const stmt = db.prepare("INSERT INTO appointment_services (appointment_id, service_id, quantity) VALUES (?, ?, ?)");
        let completed = 0;
        
        services.forEach(({ service_id, quantity = 1 }) => {
          // ะะพะปััะฐะตะผ ัะตะฝั ััะปัะณะธ
          db.get("SELECT price FROM services WHERE id = ?", [service_id], (err, service) => {
            if (!err && service) {
              totalPrice += service.price * quantity;
            }
            
            stmt.run([appointmentId, service_id, quantity], (err) => {
              if (err) {
                console.error('ะัะธะฑะบะฐ ะดะพะฑะฐะฒะปะตะฝะธั ััะปัะณะธ:', err);
              }
              
              completed++;
              if (completed === services.length) {
                stmt.finalize();
                
                // ะะฑะฝะพะฒะปัะตะผ ะพะฑััั ััะพะธะผะพััั ะทะฐะฟะธัะธ
                db.run(
                  "UPDATE appointments SET total_price = ? WHERE id = ?",
                  [totalPrice, appointmentId],
                  (err) => {
                    if (err) {
                      console.error('ะัะธะฑะบะฐ ะพะฑะฝะพะฒะปะตะฝะธั ััะพะธะผะพััะธ:', err);
                    }
                    res.json({ 
                      id: appointmentId, 
                      client_id, 
                      appointment_date, 
                      total_price: totalPrice,
                      message: 'ะะฐะฟะธัั ัะพะทะดะฐะฝะฐ ััะฟะตัะฝะพ' 
                    });
                  }
                );
              }
            });
          });
        });
      } else {
        res.json({ 
          id: appointmentId, 
          client_id, 
          appointment_date, 
          total_price: 0,
          message: 'ะะฐะฟะธัั ัะพะทะดะฐะฝะฐ ััะฟะตัะฝะพ' 
        });
      }
    }
  );
});

// ะะฑะฝะพะฒะธัั ะทะฐะฟะธัั
app.put('/api/appointments/:id', (req, res) => {
  const { appointment_date, services, notes, status } = req.body;
  
  db.run(
    "UPDATE appointments SET appointment_date = ?, notes = ?, status = ? WHERE id = ?",
    [appointment_date, notes || null, status || 'scheduled', req.params.id],
    function(err) {
      if (err) {
        res.status(500).json({ error: err.message });
        return;
      }
      
      // ะัะปะธ ะพะฑะฝะพะฒะปััััั ััะปัะณะธ, ะฟะตัะตััะธััะฒะฐะตะผ ััะพะธะผะพััั
      if (services) {
        // ะฃะดะฐะปัะตะผ ััะฐััะต ััะปัะณะธ
        db.run("DELETE FROM appointment_services WHERE appointment_id = ?", [req.params.id], () => {
          // ะะพะฑะฐะฒะปัะตะผ ะฝะพะฒัะต ััะปัะณะธ
          let totalPrice = 0;
          if (services.length > 0) {
            const stmt = db.prepare("INSERT INTO appointment_services (appointment_id, service_id, quantity) VALUES (?, ?, ?)");
            let completed = 0;
            
            services.forEach(({ service_id, quantity = 1 }) => {
              db.get("SELECT price FROM services WHERE id = ?", [service_id], (err, service) => {
                if (!err && service) {
                  totalPrice += service.price * quantity;
                }
                
                stmt.run([req.params.id, service_id, quantity], () => {
                  completed++;
                  if (completed === services.length) {
                    stmt.finalize();
                    db.run("UPDATE appointments SET total_price = ? WHERE id = ?", [totalPrice, req.params.id]);
                    res.json({ message: 'ะะฐะฟะธัั ะพะฑะฝะพะฒะปะตะฝะฐ', total_price: totalPrice });
                  }
                });
              });
            });
          } else {
            db.run("UPDATE appointments SET total_price = 0 WHERE id = ?", [req.params.id]);
            res.json({ message: 'ะะฐะฟะธัั ะพะฑะฝะพะฒะปะตะฝะฐ', total_price: 0 });
          }
        });
      } else {
        res.json({ message: 'ะะฐะฟะธัั ะพะฑะฝะพะฒะปะตะฝะฐ' });
      }
    }
  );
});

// ะฃะดะฐะปะธัั ะทะฐะฟะธัั
app.delete('/api/appointments/:id', (req, res) => {
  db.run("DELETE FROM appointment_services WHERE appointment_id = ?", [req.params.id], () => {
    db.run("DELETE FROM appointments WHERE id = ?", [req.params.id], function(err) {
      if (err) {
        res.status(500).json({ error: err.message });
        return;
      }
      res.json({ message: 'ะะฐะฟะธัั ัะดะฐะปะตะฝะฐ', changes: this.changes });
    });
  });
});

// ะะพะปััะธัั ะทะฐะฟะธัะธ ะฝะฐ ะพะฟัะตะดะตะปะตะฝะฝัั ะดะฐัั
app.get('/api/appointments/date/:date', (req, res) => {
  const date = req.params.date;
  const query = `
    SELECT 
      a.*,
      c.name as client_name,
      c.phone as client_phone
    FROM appointments a
    LEFT JOIN clients c ON a.client_id = c.id
    WHERE DATE(a.appointment_date) = DATE(?)
    ORDER BY a.appointment_date
  `;
  
  db.all(query, [date], (err, rows) => {
    if (err) {
      res.status(500).json({ error: err.message });
      return;
    }
    res.json(rows);
  });
});

// ะะฑะฝะพะฒะธัั ััะฐััั ะทะฒะพะฝะบะฐ
app.patch('/api/appointments/:id/call-status', (req, res) => {
  const { called_today } = req.body;
  
  db.run(
    "UPDATE appointments SET called_today = ? WHERE id = ?",
    [called_today ? 1 : 0, req.params.id],
    function(err) {
      if (err) {
        res.status(500).json({ error: err.message });
        return;
      }
      res.json({ 
        message: 'ะกัะฐััั ะทะฒะพะฝะบะฐ ะพะฑะฝะพะฒะปะตะฝ', 
        called_today: called_today ? 1 : 0,
        changes: this.changes 
      });
    }
  );
});

// ะะฑะฝะพะฒะธัั ััะฐััั ะทะฐะฟะธัะธ
app.patch('/api/appointments/:id/status', (req, res) => {
  const { status, discount_amount } = req.body;
  
  const updateFields = ['status = ?'];
  const updateValues = [status];
  
  if (discount_amount !== undefined) {
    updateFields.push('discount_amount = ?');
    updateValues.push(discount_amount);
  }
  
  updateValues.push(req.params.id);
  
  db.run(
    `UPDATE appointments SET ${updateFields.join(', ')} WHERE id = ?`,
    updateValues,
    function(err) {
      if (err) {
        res.status(500).json({ error: err.message });
        return;
      }
      res.json({ 
        message: 'ะกัะฐััั ะพะฑะฝะพะฒะปะตะฝ', 
        status,
        changes: this.changes
      });
    }
  );
});

// ะะฐะฒะตััะธัั ะพะฟะปะฐัั (ะฐะดะผะธะฝะธัััะฐัะพั)
app.patch('/api/appointments/:id/complete-payment', (req, res) => {
  const { discount_amount } = req.body;
  
  db.run(
    "UPDATE appointments SET status = 'completed', paid = 1, discount_amount = ? WHERE id = ?",
    [discount_amount || 0, req.params.id],
    function(err) {
      if (err) {
        res.status(500).json({ error: err.message });
        return;
      }
      res.json({ 
        message: 'ะะฟะปะฐัะฐ ะทะฐะฒะตััะตะฝะฐ', 
        status: 'completed',
        paid: 1,
        changes: this.changes
      });
    }
  );
});

// ะะฐะฒะตััะธัั ะฟัะธะตะผ ะฒัะฐัะพะผ (ะพะฑะฝะพะฒะธัั ะดะธะฐะณะฝะพะท, ััะปัะณะธ, ะผะฐัะตัะธะฐะปั)
app.patch('/api/appointments/:id/complete-visit', (req, res) => {
  const { diagnosis, services, materials } = req.body;
  const appointmentId = req.params.id;
  
  // ะฃะดะฐะปัะตะผ ััะฐััะต ััะปัะณะธ ะธ ะผะฐัะตัะธะฐะปั
  db.run("DELETE FROM appointment_services WHERE appointment_id = ?", [appointmentId], (err) => {
    if (err) {
      res.status(500).json({ error: err.message });
      return;
    }

    db.run("DELETE FROM appointment_materials WHERE appointment_id = ?", [appointmentId], (err) => {
      if (err) {
        res.status(500).json({ error: err.message });
        return;
      }

      let totalPrice = 0;
      let servicesProcessed = 0;
      let materialsProcessed = 0;
      const totalServicesCount = services ? services.length : 0;
      const totalMaterialsCount = materials ? materials.length : 0;

      // ะะฑัะฐะฑะพัะบะฐ ััะปัะณ
      if (totalServicesCount > 0) {
        const servicesStmt = db.prepare("INSERT INTO appointment_services (appointment_id, service_id, quantity) VALUES (?, ?, ?)");
        
        services.forEach(({ service_id, quantity = 1 }) => {
          db.get("SELECT price FROM services WHERE id = ?", [service_id], (err, service) => {
            if (!err && service) {
              totalPrice += service.price * quantity;
              servicesStmt.run(appointmentId, service_id, quantity);
            }
            
            servicesProcessed++;
            
            if (servicesProcessed === totalServicesCount && materialsProcessed === totalMaterialsCount) {
              servicesStmt.finalize();
              updateAppointmentTotal();
            }
          });
        });
      }

      // ะะฑัะฐะฑะพัะบะฐ ะผะฐัะตัะธะฐะปะพะฒ
      if (totalMaterialsCount > 0) {
        const materialsStmt = db.prepare("INSERT INTO appointment_materials (appointment_id, material_id, quantity) VALUES (?, ?, ?)");
        
        materials.forEach(({ material_id, quantity = 1 }) => {
          db.get("SELECT price FROM materials WHERE id = ?", [material_id], (err, material) => {
            if (!err && material) {
              totalPrice += material.price * quantity;
              materialsStmt.run(appointmentId, material_id, quantity);
            }
            
            materialsProcessed++;
            
            if (servicesProcessed === totalServicesCount && materialsProcessed === totalMaterialsCount) {
              materialsStmt.finalize();
              updateAppointmentTotal();
            }
          });
        });
      }

      // ะัะปะธ ะฝะตั ะฝะธ ััะปัะณ, ะฝะธ ะผะฐัะตัะธะฐะปะพะฒ
      if (totalServicesCount === 0 && totalMaterialsCount === 0) {
        updateAppointmentTotal();
      }

      function updateAppointmentTotal() {
        // ะะฑะฝะพะฒะปัะตะผ ะทะฐะฟะธัั: ะดะธะฐะณะฝะพะท, ัะตะฝั ะธ ััะฐััั "ะณะพัะพะฒ ะบ ะพะฟะปะฐัะต"
        db.run(
          "UPDATE appointments SET diagnosis = ?, total_price = ?, status = 'ready_for_payment' WHERE id = ?",
          [diagnosis || '', totalPrice, appointmentId],
          function(err) {
            if (err) {
              res.status(500).json({ error: err.message });
              return;
            }
            
            res.json({ 
              message: 'ะัะธะตะผ ะทะฐะฒะตััะตะฝ, ะทะฐะฟะธัั ะณะพัะพะฒะฐ ะบ ะพะฟะปะฐัะต',
              appointmentId,
              totalPrice,
              status: 'ready_for_payment'
            });
          }
        );
      }
    });
  });
});

// ะะพะปััะธัั ะธััะพัะธั ะฒะธะทะธัะพะฒ ะบะปะธะตะฝัะฐ
app.get('/api/clients/:id/appointments', (req, res) => {
  db.all(
    "SELECT * FROM appointments WHERE client_id = ? ORDER BY appointment_date DESC",
    [req.params.id],
    (err, appointments) => {
      if (err) {
        res.status(500).json({ error: err.message });
        return;
      }
      
      // ะะปั ะบะฐะถะดะพะน ะทะฐะฟะธัะธ ะฟะพะปััะฐะตะผ ะตั ััะปัะณะธ ะธ ะผะฐัะตัะธะฐะปั
      const appointmentsWithData = [];
      let processed = 0;
      
      if (appointments.length === 0) {
        return res.json([]);
      }
      
      appointments.forEach(appointment => {
        // ะะพะปััะฐะตะผ ััะปัะณะธ
        db.all(
          `SELECT aps.service_id, aps.quantity, s.name, s.price 
           FROM appointment_services aps
           JOIN services s ON aps.service_id = s.id
           WHERE aps.appointment_id = ?`,
          [appointment.id],
          (err, services) => {
            if (err) {
              console.error('ะัะธะฑะบะฐ ะฟะพะปััะตะฝะธั ััะปัะณ:', err);
              services = [];
            }
            
            const servicesArray = services.map(s => ({
              service_id: s.service_id,
              name: s.name,
              price: s.price,
              quantity: s.quantity
            }));
            
            // ะะพะปััะฐะตะผ ะผะฐัะตัะธะฐะปั
            db.all(
              `SELECT apm.material_id, apm.quantity, m.name, m.price, m.unit
               FROM appointment_materials apm
               JOIN materials m ON apm.material_id = m.id
               WHERE apm.appointment_id = ?`,
              [appointment.id],
              (err, materials) => {
                if (err) {
                  console.error('ะัะธะฑะบะฐ ะฟะพะปััะตะฝะธั ะผะฐัะตัะธะฐะปะพะฒ:', err);
                  materials = [];
                }
                
                const materialsArray = materials.map(m => ({
                  material_id: m.material_id,
                  name: m.name,
                  price: m.price,
                  quantity: m.quantity,
                  unit: m.unit
                }));
                
                // ะะพะปััะฐะตะผ ะธะฝัะพัะผะฐัะธั ะพ ะฒัะฐัะต
                db.get(
                  `SELECT lastName, firstName, middleName, specialization
                   FROM doctors WHERE id = ?`,
                  [appointment.doctor_id],
                  (err, doctor) => {
                    appointmentsWithData.push({
                      ...appointment,
                      services: servicesArray,
                      materials: materialsArray,
                      doctor: doctor || null
                    });
                    
                    processed++;
                    if (processed === appointments.length) {
                      res.json(appointmentsWithData);
                    }
                  }
                );
              }
            );
          }
        );
      });
    }
  );
});

// ะ ะฟัะพะดะฐะบัะตะฝะต ัะฐะทะดะฐะตะผ ััะฐัะธัะตัะบะธะต ัะฐะนะปั React ะธ SPA ัะพััะธะฝะณ
if (NODE_ENV === 'production') {
  // ะกะฝะฐัะฐะปะฐ ัะฐะทะดะฐะตะผ ััะฐัะธัะตัะบะธะต ัะฐะนะปั (CSS, JS, ะธะทะพะฑัะฐะถะตะฝะธั)
  app.use(express.static(path.join(__dirname, '../client/build')));
  
  // ะัะต ะพััะฐะปัะฝัะต ะทะฐะฟัะพัั ะพัะฟัะฐะฒะปัะตะผ ะฝะฐ React ะฟัะธะปะพะถะตะฝะธะต (ะดะปั SPA ัะพััะธะฝะณะฐ)
  app.get('*', (req, res) => {
    res.sendFile(path.join(__dirname, '../client/build/index.html'));
  });
}

// ะะฐะฟััะบ ัะตัะฒะตัะฐ
app.listen(PORT, '0.0.0.0', () => {
  console.log(`๐ ะกะตัะฒะตั ะทะฐะฟััะตะฝ ะฝะฐ ะฟะพััั ${PORT}`);
  console.log(`๐ API ะดะพัััะฟะตะฝ ะฟะพ ะฐะดัะตัั http://localhost:${PORT}/api`);
  if (NODE_ENV === 'production') {
    console.log(`๐ ะัะธะปะพะถะตะฝะธะต ะดะพัััะฟะฝะพ ะฝะฐ http://localhost:${PORT}`);
  }
});

